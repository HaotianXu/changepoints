---
title: "example_VAR1"
author: "Haotian Xu"
date: "9/2/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is a simple guide for changepoint detection in transition matrix of a VAR1 model.

Function _simu.VAR1_ simulates VAR1 model without changepoint in transition matrix. Then, the data with changepoints contains several segments with different transition matrices. 

Dynamic programming and local refinement are implemented for VAR1 changepoint detection:

* _DP.VAR1_: performs dynamic programming for VAR1 changepoint detection through l0 penalty.
   + _CV.search.DP.VAR1_: performs grid search to select tuning parameters (gamma for l0, lambda for l1) through Cross-Validation.

* _local.refine.VAR1_: performs local refinement for an initial changepoint estimation.
  + _local.refine.CV.VAR1_: performs grid search to select the tuning parameter zeta for group lasso through cross-validation.

# Simulate data
```{r}
library(changepoints)
## parameters for simulating data
rho = 0.3 #candidate of rho (rho can not be too large so that the time series is stable)
p = 20 # dimension
sigma = 1 # standard deviation of error terms
delta1 = 10 # minimum gap for DP
delta.local = 10 # minimum gap for local.refine
n = 30 # length for each segment
v1 = 2*(seq(1,p,1)%%2) - 1
v2 = -v1 
AA = matrix(0, nrow = p, ncol = p-2)
A1 = rho * cbind(v1,v2,AA) # transition matrix for the first segment
A2 = rho * cbind(v2,v1,AA) # transition matrix for the second segment
A3 = A1 # transition matrix for the third segment

set.seed(0)
# generate data
data = simu.VAR1(sigma, p, 2*n+1, A1)
data = cbind(data, simu.VAR1(sigma, p, 2*n, A2, vzero=c(data[,ncol(data)])))
data = cbind(data, simu.VAR1(sigma, p, 2*n, A3, vzero=c(data[,ncol(data)])))
cpt_true = c(2*n, 4*n)
```

# Perform dynamic programming
```{r}
gamma_set = c(4, 5)#, 10) # a set of tuning parameters for DP
lambda_set = c(4, 5) #,10,20) # a set of tuning parameters for lasso
start.time <- Sys.time()
DP_result = CV.search.DP.VAR1(data, gamma_set, lambda_set, delta1) # grid search through cross-validation
end.time <- Sys.time(); time.taken <- end.time - start.time; print(time.taken)
min_idx = as.vector(arrayInd(which.min(DP_result$test_error), dim(DP_result$test_error)))# select gamma achieves the minimum validation error
cpt_DP_hat = unlist(DP_result$cpt_hat[min_idx[1], min_idx[2]]) # estimated changepoints by DP
cpt_DP_hat
Hausdorff.dist(cpt_DP_hat, cpt_true)
zeta_set = c(1, 2 ,3) # tuning parameter for group lasso
cpt_DPlr_hat = local.refine.CV.VAR1(cpt_DP_hat, data, zeta_set, delta.local, w = 1/3) # perform local refinement
cpt_DPlr_hat
Hausdorff.dist(cpt_DPlr_hat, cpt_true)
```